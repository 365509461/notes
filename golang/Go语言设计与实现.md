# 编译

**Go 的编译器在逻辑上可以被分成四个阶段：词法与语法分析、类型检查和 AST 转换、通用 SSA 生成和最后的机器代码生成，下面是四个阶段的所做的工作**

## 一、编译过程

### 词法与语法分析

词法分析是计算机科学中将字符串序列转换为标记（token）序列的过程，一般将词法分析成为词法解析器。

而语法分析的输入是词法分析输出的 token 序列，语法分析会将 token 序列按照一定的规范(grammar)解析。每个 go 的源代码都会被归纳成一个 SourceFile 的结构。

```go
SourceFile = PackageClause ";" { ImportDecl ";" } { TopLevelDecl ";" } .
```

词法分析会返回一个不包含空格、换行等字符的 Token 序列。例如：`package,json,import,(,)`，而语法分析会把 Token 序列转换成有意义的结构体，即语法树：

```go
"json.go": SourceFile {
    PackageName: "json",
    ImportDecl: []Import{
        "io",
    },
    TopLevelDecl: ...
}
```

Token 到上述抽象语法树（AST）的转换过程会用到语法解析器，每一个 AST 都对应着一个单独的 Go 语言文件，这个抽象语法树中包括当前文件属于的包名、常量、结构体和函数等。

语法解析的过程中发生任何错误都会导致整个编译过程被终止。

当拿到一组文件的抽象语法树之后，Go 语言的编译器会对语法树中定义和使用的类型进行检查，类型检查会按照以下的顺序分别验证和处理不同类型的节点：

1. 常量、类型和函数名及类型
2. 变量的赋值和初始化
3. 函数和闭包的主体
4. 哈希键值对的类型
5. 导入函数体
6. 外部的声明

通过对抽象语法树的遍历，我们在每个节点上都会对当前子树的类型进行验证，以保证节点不存在类型错误，所有的类型错误和不匹配都会在这一个阶段被暴露出来，其中包括结构体对接口的实现

### 编译器入口

Go 语言的编译器入口在 `src/cmd/complie/internal/gc/main.go`文件中，其中 600 多行的 `cmd/complie/internal/gc.Main`就是 Go 语言编译器的主程序，该函数会先获取命令行传入的参数并更新编译选项和配置，随后会调用 `cmd/complie/internal/gc.parseFiles` 对输入的文件进行词法和语法分析得到抽象语法树：

```go
func Main(archInit func(*Arch)) {
  ...
  lines := parseFiles(flag.Args())
}
```

得到抽象语法树后会分九个阶段对抽象语法树进行更新和编译，就像我们在上面介绍的，抽象语法树会经历类型检查，SSA 中间代码生成以及机器码生成三个阶段：

1. 检查常量、类型和函数的类型
2. 处理变量的赋值
3. 对函数的主体进行类型检查
4. 决定如何捕获变量
5. 检查内联函数的类型
6. 进行逃逸分析
7. 将闭包的主体转换成引用的捕获变量
8. 编译顶层函数
9. 检查外部依赖的声明

## 二、词法分析和语法分析

### 词法分析

源代码对于编译器来说其实就是一串无法被理解的字符串，为了理解这些字符需要做的第一件事就是**将字符串分组**，这样可以降低理解字符串的成本，简化分析源代码的过程

```go
make(chan int)
```

对于一个不懂编程的人来说看到上述代码会将其分为几个部分 `make`、`chan`、`int`、`()`，其实凭直觉分解文本的过程就是**词法分析**，词法分析是将字符序列转换为标记（token）序列的过程。

### 语法分析

语法分析是根据特定语法（grammar）对 token 序列构成的输入文本进行分析并确定语法结构的过程，词法分析器输出的结果 token 序列是语法分析器的输入。